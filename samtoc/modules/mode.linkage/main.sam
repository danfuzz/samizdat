## Copyright 2013-2014 the Samizdat Authors (Dan Bornstein et alia).
## Licensed AS IS and WITHOUT WARRANTY under the Apache License,
## Version 2.0. Details: <http://www.apache.org/licenses/LICENSE-2.0>

##
## Compilation mode "linkage" which generates `.saminfo` files.
##

import @utf8 ./template.txt;

import CodeGen;
import DataCode;
import Template;

import core.Io0;
import core.Lang0Node;
import core.Lang2;

export fn compile(resolver, sourcePath, targetPath) {
    ## Note: We *don't* call `simplify` on the parsed program tree, as that
    ## would erase salient info about the exports.
    def sourceText = $Io0::readFileUtf8(sourcePath);
    def tree = $Lang2::parseProgram(sourceText);

    def infoMap = $Lang0Node::makeInfoMap(tree);
    def info = "\%q(infoMap)";
    def outputText = $Template::apply($template, {info});

    $Io0::writeFileUtf8(targetPath, outputText)
};

export def SUFFIX = "saminfo";
