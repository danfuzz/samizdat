## Copyright 2013 the Samizdat Authors (Dan Bornstein et alia).
## Licensed AS IS and WITHOUT WARRANTY under the Apache License,
## Version 2.0. Details: <http://www.apache.org/licenses/LICENSE-2.0>

##
## Translate execution trees into corresponding C code.
##

def DataCode = moduleUse({name: ["DataCode"]});
def Lang0Node = moduleUse({name: ["Lang0Node"]});

def Io1 = moduleUse({name: ["core", "Io1"]});

def get_actuals    = Lang0Node::get_actuals;
def get_formals    = Lang0Node::get_formals;
def get_function   = Lang0Node::get_function;
def get_id         = Lang0Node::get_id;
def get_name       = Lang0Node::get_name;
def get_statements = Lang0Node::get_statements;
def get_value      = Lang0Node::get_value;
def get_varRefs    = Lang0Node::get_varRefs;
def get_yield      = Lang0Node::get_yield;
def get_yieldDef   = Lang0Node::get_yieldDef;

## Generic function to perform the translation.
def translate = makeRegularGeneric("translate", 1, 1);


genericBind(
    translate,
    "call",
    fn call_translate(node) {
        ## TODO: Handle `voidable` and `interpolate` nodes.
        def actuals = (a in node.actuals <> translate(a));
        <> DataCode::makeCall(translate(node.function), actuals*)
    });

genericBind(
    translate,
    "closure",
    fn closure_translate(node) {
        Io1::die("Cannot translate raw `closure` node.")
    });

genericBind(
    translate,
    "closureRef",
    fn closureRef_translate(node) {
        <> "NULL /* TODO: closure_\(node.id) */"
    });

genericBind(
    translate,
    "expression",
    fn expression_translate(node) {
        <> translate(node.value)
    });

genericBind(
    translate,
    "interpolate",
    fn interpolate_translate(node) {
        <> "NULL /* TODO: interpolate */"
    });

genericBind(
    translate,
    "literalRef",
    fn literalRef_translate(node) {
        <> "LIT_\(node.id)"
    });

genericBind(
    translate,
    "varBind",
    fn varBind_translate(node) {
        <> "NULL /* TODO: varBind */"
    });

genericBind(
    translate,
    "varDef",
    fn varDef_translate(node) {
        <> "NULL /* TODO: varDef */"
    });

genericBind(
    translate,
    "varDefMutable",
    fn varDefMutable_translate(node) {
        <> "NULL /* TODO: varDefMutable */"
    });

genericBind(
    translate,
    "varRef",
    fn varRef_translate(node) {
        <> "NULL /* TODO: varRef */"
    });

genericBind(
    translate,
    "voidable",
    fn voidable_translate(node) {
        <> "NULL /* TODO: voidable */"
    });

## Translates and converts to a string, without indentation.
fn translateNoIndent(node) {
    <> translateIndent(node, 0, 100_000_000)
};

## Translates and converts to a string, with indentation.
fn translateIndent(node, level, maxColumns) {
    <> DataCode::indent(translate(node), level, maxColumns)
};

<> {
    translate,
    translateIndent,
    translateNoIndent
}
