/*
 * GENERATED CODE!
 * GENERATED CODE!
 * GENERATED CODE!
 *
 * This code *might* be derived from a copyrighted source. Proceed with
 * caution!
 */

#include "type/OneOff.h"
#include "type/String.h"
#include "util.h"

static zvalue lookup(zvalue env, const char *name) {
    zvalue result = get(env, stringFromUtf8(-1, name));

    if (result == NULL) {
        die("Binding missing: %s", name);
    }

    return result;
}

zvalue eval(zvalue env) {
    zvalue moduleLoad = lookup(env, "moduleLoad");
    zvalue codeModule = FUN_CALL(moduleLoad, stringFromUtf8(-1, "core.Code"));
    zvalue evalFn = lookup(codeModule, "eval");
    zvalue langModule = FUN_CALL(moduleLoad, stringFromUtf8(-1, "core.Lang2"));
    zvalue parseProgramFn = lookup(langModule, "parseProgram");

    zvalue progStr = stringFromUtf8(-1,
        \%q(source)
    );

    zvalue progTree = FUN_CALL(parseProgramFn, progStr);
    zvalue evalResult = FUN_CALL(evalFn, env, progTree);

    return evalResult;
}
