## Copyright 2013 the Samizdat Authors (Dan Bornstein et alia).
## Licensed AS IS and WITHOUT WARRANTY under the Apache License,
## Version 2.0. Details: <http://www.apache.org/licenses/LICENSE-2.0>

def CommandLine = moduleUse({name: ["core", "CommandLine"]});
def Io1 = moduleUse({name: ["core", "Io1"]});


## Removes the `.*` suffix from `name`.
fn withoutSuffix(name) {
    def dotsAt = [ index in (0..), ch in name <> (ch == ".") & index ];

    if (dotsAt == []) {
        ## No suffix on the name.
        return name
    } else {
        def lastDot = Collection::last(dotsAt);
        return Collection::slice(name, 0, lastDot)
    }
};

fn getOutputPath(sourcePath, args) {
    if (def output = args::options::output) {
        return Io1::pathFromFlat(output)
    } else {
        def baseName = withoutSuffix(Collection::last(sourcePath));
        return [Collection::butLast(sourcePath)*, "\(baseName).c"];
    }
};

fn doOne(modeModule, args, sourceName) {
    def sourcePath = Io1::pathFromFlat(sourceName);
    def targetPath = getOutputPath(sourcePath, args);

    Io1::note("\
        \%q(sourcePath)
        -> \%q(targetPath)\n");

    modeModule::compile(sourcePath, targetPath);
};

fn main(selfPath, rawArgs*) {
    Io1::note("\
        Starting: \%q(selfPath)
        Raw args: \%q(rawArgs)\n");

    def args = CommandLine::parseArgs(rawArgs);
    def modeName = args::options::mode | "fake";
    def modeModule = moduleUse({name: [modeName]});
    def sources = args::args;

    if (Collection::sizeOf(sources) == 0) {
        Io1::note("No source files specified!");
        return 1
    };

    Io1::note("Mode: \%q(modeName)\n");

    for (s in sources) {
        doOne(modeModule, args, s)
    };
};

<> {main}
