## Copyright 2013 the Samizdat Authors (Dan Bornstein et alia).
## Licensed AS IS and WITHOUT WARRANTY under the Apache License,
## Version 2.0. Details: <http://www.apache.org/licenses/LICENSE-2.0>

##
## Samizdat Layer 1 tokenizer
##
## The following is a near-transliteration of the token grammar in
## the Samizdat Layer 0 and Samizdat Layer 1 specifications.
##


##
## These definitions are meant to mirror the code in the spec for
## tokenization, as closely as possible.
##

## Documented in spec.
def KEYWORDS = Generator::collectAsMap(
    Generator::makeFilterGenerator([
        "def", "fn", "return",
        ## Layer 2 defines additional keywords here.
        []*])
        { name <> {(name): @(name)} });

## Documented in spec.
def INT_CHARS = {
    "0": 0, "1": 1, "2": 2, "3": 3, "4": 4,
    "5": 5, "6": 6, "7": 7, "8": 8, "9": 9,
    "a": 10, "b": 11, "c": 12, "d": 13, "e": 14, "f": 15,
    "A": 10, "B": 11, "C": 12, "D": 13, "E": 14, "F": 15,
    "_": -1
};

## Documented in spec.
fn intFromDigitChar(ch) {
    <> get(INT_CHARS, typeOf(ch))
};

## Documented in spec.
fn processStringParts(parts) {
    <> @string(cat("", parts*))
};

## Documented in spec.
def tokWhitespace = Peg::makeMainSequence(
    Peg::makeLookaheadSuccess(Peg::makeCharSet("# \n")),
    Peg::makePlus(
        Peg::makeChoice(
            Peg::makePlus(Peg::makeCharSet(" \n")),
            Peg::makeSequence(
                Peg::makeString("#"),
                Peg::makeCharSet("#!"),
                Peg::makeStar(Peg::makeCharSetComplement("\n"))))));

## Documented in spec.
def tokPunctuation = Peg::makeMainSequence(
    Peg::makeLookaheadSuccess(Peg::makeCharSet("&@:.,=-+?;*<>{}()[]", "/|!%")),
    Peg::makeChoice(
        Peg::makeString("->"),
        Peg::makeString(":="),
        Peg::makeString("::"),
        Peg::makeString(".."),
        Peg::makeString("<>"),
        Peg::makeString("{/"),
        Peg::makeString("/}"),
        Peg::any));

## Documented in spec.
def tokInt = Peg::makeMainSequence(
    Peg::makePlus(
        Peg::makeSequence(
            Peg::makeCharSet("0123456789"),
            Peg::makeCode(intFromDigitChar))),
    Peg::makeCode { digits ->
        def value = Generator::doReduce1(digits, 0)
            { digit, result <> Number::add(digit, Number::mul(result, 10)) };
        <> @int(value)
    });

## Documented in spec.
def tokStringPart = Peg::makeMainChoice(
    Peg::makeSequence(
        Peg::makePlus(Peg::makeCharSetComplement("\\\"\n")),
        Peg::makeCode(Peg::stringFromTokenList)),
    Peg::makeSequence(
        Peg::makeString("\n"),
        Peg::makeStar(Peg::makeString(" ")),
        Peg::makeResult("\n")),
    Peg::makeSequence(
        Peg::makeString("\\"),
        Peg::makeChoice(
            Peg::makeSequence(Peg::makeString("\\"), Peg::makeResult("\\")),
            Peg::makeSequence(Peg::makeString("\""), Peg::makeResult("\"")),
            Peg::makeSequence(Peg::makeString("n"),  Peg::makeResult("\n")),
            Peg::makeSequence(Peg::makeString("r"),  Peg::makeResult("\r")),
            Peg::makeSequence(Peg::makeString("t"),  Peg::makeResult("\t")),
            Peg::makeSequence(Peg::makeString("0"),  Peg::makeResult("\0")))));

## Documented in spec.
def tokString = Peg::makeMainSequence(
    Peg::makeString("\""),
    Peg::makeStar(tokStringPart),
    Peg::makeChoice(
        Peg::makeSequence(
            Peg::makeString("\""),
            Peg::makeCode { ., parts, . <> processStringParts(parts) }),
        Peg::makeCode { ., . <> @error("Unterminated string literal.") }));

## These are all the characters which are allowed to start an identifier.
def IDENTIFIER_START_CHARS =
    "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_";

## These are all the characters which are allowed to be in an identifier.
def IDENTIFIER_CHARS = cat(IDENTIFIER_START_CHARS, "0123456789");

## Documented in spec.
def tokIdentifier = Peg::makeMainSequence(
    Peg::makeCharSet(IDENTIFIER_START_CHARS),
    Peg::makeStar(Peg::makeCharSet(IDENTIFIER_CHARS)),
    Peg::makeCode { one, rest ->
        def string = Peg::stringFromTokenList([one, rest*]);
        <> ifValueOr { <> get(KEYWORDS, string) }
            { <> @identifier(string) }
    });

## Documented in spec.
def tokQuotedIdentifier = Peg::makeMainSequence(
    Peg::makeString("\\"),
    tokString,
    Peg::makeCode { ., s <> @identifier(dataOf(s)) });

## Documented in spec.
def tokError = Peg::makeMainSequence(
    Peg::any,
    Peg::makeStar(Peg::makeCharSetComplement("\n")),
    Peg::makeCode { badCh, . ->
        def msg = cat("Unrecognized character: ", typeOf(badCh));
        <> @error(msg)
    });

## Documented in spec.
def tokToken = Peg::makeMainChoice(
    tokString,
    tokIdentifier,
    tokQuotedIdentifier,
    tokPunctuation,
    tokInt,
    tokError);

## Documented in spec.
def tokFile = Peg::makeMainSequence(
    Peg::makeStar(
        Peg::makeSequence(
            Peg::makeOpt(tokWhitespace),
            tokToken)),
    Peg::makeOpt(tokWhitespace),
    Peg::makeCode { tokens, . <> tokens });


##
## Exported Definitions
##

## Documented in spec.
fn tokenize(programText) {
    <> Peg::apply(tokFile, programText)
};

<> {
    tokenize
}
