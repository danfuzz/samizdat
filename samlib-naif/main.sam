## Copyright 2013-2014 the Samizdat Authors (Dan Bornstein et alia).
## Licensed AS IS and WITHOUT WARRANTY under the Apache License,
## Version 2.0. Details: <http://www.apache.org/licenses/LICENSE-2.0>

##
## Samizdat Core Library Secondary Loader
##
## This gets loaded from `boot.sam` and is responsible for returning
## the standard global variable environment.
##

#= language core.Lang0

note("\nLoading module system...");

def $Globals      = moduleLoad(["core", "Globals"]);
def $ModuleSystem = moduleLoad(["core", "ModuleSystem"]);

## Initializes the world, and returns the final global variable environment.
## `libraryPath` is the filesystem path to the core library.
## `primitiveEnvironment` is the map of native bindings.
export fn main(libraryPath, primitiveEnvironment) {
    def earlyGlobals = {
        primitiveEnvironment*,
        $Globals::earlyEnvironment()*
    };

    note("\nLoading core library...");

    ## `null` isn't yet defined when this file is parsed. Hence, `@Null`.
    def loader = $ModuleSystem::makeModuleLoader(
        cat(libraryPath, "/modules"), earlyGlobals, @Null);

    def innerGlobals = $ModuleSystem::moduleLoad(loader, ["core", "Globals"]);
    def result = innerGlobals::fullEnvironment();

    note("    [fin]\n");
    <> result
};
